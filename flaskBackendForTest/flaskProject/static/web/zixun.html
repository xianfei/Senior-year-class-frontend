<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>资讯</title>
    <link rel="stylesheet" href="./mdui/css/mdui.css"/>
    <link rel="stylesheet" href="mycss.css"/>
</head>

<body>

<div id="xf-tab" style="width: 60%;position: fixed;margin-top: -48px">
    <div class="mdui-tab" mdui-tab>
        <a href="#example1-tab3" class="mdui-ripple" style="font-size: 20px;font-weight:800;">广场</a>
        <a href="#example1-tab2" class="mdui-ripple" style="font-size: 20px;font-weight:800">关注</a>
    </div>
</div>

<div id="xf-contain">
    <div id="example1-tab1" class="mdui-p-a-2">
        <div id="minirefresh" class="minirefresh-wrap">
            <div class="minirefresh-scroll">
                <div id="test">
                </div>
            </div>
        </div>
    </div>
    <div id="example1-tab2" class="mdui-p-a-2">
        <div id="cyxz" class="mdui-appbar-with-tab">
        </div>
    </div>
    <div id="example1-tab3" class="mdui-p-a-2">
        <div id="zxxx" class="mdui-appbar-with-tab">
        </div>
    </div>
    <script src="./mdui/js/mdui.js"></script>
    <script src="jquery.js"></script>
    <script>
        var currentID = -1;
        var currentMoment = '';
        var num = 0;
        var loadtime = new Date().getTime();
        if (localStorage.getItem("lastPage") == 'zixun') {
            // addTenCard();

            function addTenCard(onSucceedsFun) {
                try {
                    $.ajax({
                        type: 'POST',
                        timeout: 5000,
                        url: ajaxurl, data: {begin: num, end: num + 19, time: loadtime}, success: function (result) {
                            console.log(result)
                            if(onSucceedsFun)onSucceedsFun()
                            for (var res of result) {
                                var media
                                if (res.attachmentType == 3) media = String.raw`
                         <div class="mdui-card-media test_img">
                            <img src="${res.img}"/>
                   </div>
                         `
                                else if (res.attachmentType == 1)
                                    media = String.raw`
                         <iframe class="test_iframe" src="${res.attachment}">

                   </iframe>
                         `
                                else media = ''
                                $('#test').append(String.raw`
                <div class="momentCard" onclick="currentMoment = this.innerHTML;currentID = ${res.momentID};clickShowFull('detail.html','-moment-id-${res.momentID}');">
                    <div xf-user-id="${res.userId}" xf-moment-id="${res.momentID}" class="momentInfo" style="display: none"></div>
                 <div class="mdui-card-header" style="padding: 16px 5px 10px;">
    <img class="mdui-card-header-avatar" src="${res.userAvatar}"/>
    <div class="mdui-card-header-title">${res.userName}</div>
    <div class="mdui-card-header-subtitle">
    ${new Date(res.time).format("yyyy-MM-dd hh:mm:ss")}</div>
  </div>
                  <div class="mdui-card-primary-title" style="margin-left: 5px;font-size: 18px;line-height: 26px;">${res.text}</div>
 ${media}<div class="mdui-card-header-subtitle" style="text-align: end;padding:5px 0 10px 0">
<div><span onclick="var ev = window.event || arguments.callee.caller.arguments[0];if (window.event) ev.cancelBubble = true;
else { ev.stopPropagation();} this.innerHTML = this.innerHTML.replace(/(\d+)/g,parseInt(this.innerHTML.replace(/(\D*)(\d+)/g,'$2'))+1).replace('material-icons','material-icons mdui-icon-red')"><i class="mdui-icon material-icons">favorite_border</i> ${res.liked} &nbsp;&nbsp;
</span><span onclick="var ev = window.event || arguments.callee.caller.arguments[0];if (window.event) ev.cancelBubble = true;
else { ev.stopPropagation();}prompt('评论##请输入评论内容')"><i class="mdui-icon material-icons">chat_bubble_outline</i> ${res.comment} </span> &nbsp;&nbsp;&nbsp;&nbsp;</div>


                </div><div style="width: 95%;height: 1px;background: #eee;margin: auto;"></div>`)
                                num++;
                            }
                        }, error: function (jqXHR, exception) {
                            var msg = '';
                            if (exception === 'timeout') {
                                msg = '连接超时.';
                            } else if (jqXHR.status === 0) {
                                msg = '无法连接到服务器.\n';
                            } else if (jqXHR.status == 404) {
                                msg = 'Requested page not found. [404]';
                            } else if (jqXHR.status == 500) {
                                msg = 'Internal Server Error [500].';
                            } else if (exception === 'parsererror') {
                                msg = 'Requested JSON parse failed.';
                            } else if (exception === 'timeout') {
                                msg = '连接超时.';
                            } else if (exception === 'abort') {
                                msg = 'Ajax request aborted.';
                            } else {
                                msg = 'Uncaught Error.\n' + jqXHR.responseText;
                            }
                            $('#test').append(String.raw`<div id="errorInfo" style="border-radius: 20px;margin: 30px 35px 10px 35px;overflow: visible;height: 100px" class="mdui-card mdui-shadow-3">
                <img src="crying-cat.png" style="width: 80px;height: 80px;margin-left: -30px;margin-top: -35px">
                <span style="color: #ffb739;font-size: 20px;font-weight: 600;top: -15px;position: relative;">错误</span>
                <br><span style="margin-left: 30px;margin-right: 10px">${msg}</span>

            </div>`);
                        }
                    });
                } catch (e) {
                    $('#test').append(String.raw`<div id="errorInfo" style="border-radius: 20px;margin: 30px 35px 10px 35px;overflow: visible;height: 100px" class="mdui-card mdui-shadow-3">
                <img src="crying-cat.png" style="width: 80px;height: 80px;margin-left: -30px;margin-top: -35px">
                <span style="color: #ffb739;font-size: 20px;font-weight: 600;top: -15px;position: relative;">错误</span>
                <br><span style="margin-left: 30px;margin-right: 10px">${e}</span>

            </div>`);
                }


            }

            var requestDelayTime = 600;

            var miniRefresh = new MiniRefresh({
                container: '#minirefresh',
                down: {
                    callback: function () {
                        setTimeout(function () {
                            // 每次下拉刷新后，上拉的状态会被自动重置

                                num = 0;
                                loadtime = new Date().getTime();
                                 $('#test').html("")
                                addTenCard(()=>{miniRefresh.endDownLoading()})

                        }, requestDelayTime);
                    }
                },
                up: {
                    isAuto: true,
                    callback: function () {
                        setTimeout(function () {
                            addTenCard((needstop)=>{if(needstop)miniRefresh.endUpLoading(true);else miniRefresh.endUpLoading(false);})
                            console.log('will log more')

                        }, requestDelayTime);
                    }
                }
            });
            /*
            $(window).scroll(function () {
                var scrollTop = $(this).scrollTop();    //滚动条距离顶部的高度
                var scrollHeight = $(document).height();   //当前页面的总高度
                var clientHeight = $(this).height();    //当前可视的页面高度
                // console.log("top:"+scrollTop+",doc:"+scrollHeight+",client:"+clientHeight);
                if (scrollTop + clientHeight >= scrollHeight - 1) {   //距离顶部+当前高度 >=文档总高度 即代表滑动到底部 count++;         //每次滑动count加1
                    // filterData(serviceTypeId, industryId, cityId, count); //调用筛选方法，count为当前分页数
                    setTimeout(function () {
                        if (!isLoading) {
                            addTenCard()
                            console.log('will log more')
                        }
                    }, 500)
                } else if (scrollTop <= 0) {
                    //滚动条距离顶部的高度小于等于0 TODO
                    // alert("下拉刷新？");
                }
            });
            */
        }
    </script>
</div>
</body>

</html>